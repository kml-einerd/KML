name: Sincronização Ações Baratas B3

on:
  workflow_dispatch: {}
  schedule:
    # Semanal - Universo + Fundamentos (domingo 02:00 UTC)
    - cron: "0 2 * * 0"
    # Diário - Preços Diários (03:00 UTC)
    - cron: "0 3 * * *"
    # A cada 5 minutos em dias de semana (10:00–17:00 UTC)
    - cron: "*/5 10-17 * * 1-5"

jobs:
  atualizar_universo_acoes:
    name: Atualizar Universo de Ações
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        working-directory: backend-acoes-baratas
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug Environment Variables
        run: |
          echo "Checking environment variables..."
          if [ -n "$SUPABASE_URL" ]; then echo "SUPABASE_URL is set"; else echo "SUPABASE_URL is NOT set"; fi
          if [ -n "$SUPABASE_SERVICE_KEY" ]; then echo "SUPABASE_SERVICE_KEY is set"; else echo "SUPABASE_SERVICE_KEY is NOT set"; fi
          if [ -n "$BRAPI_API_KEY" ]; then echo "BRAPI_API_KEY is set"; else echo "BRAPI_API_KEY is NOT set"; fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BRAPI_API_KEY: ${{ secrets.BRAPI_API_KEY }}

      - name: Rodar job de universo de ações
        working-directory: backend-acoes-baratas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BRAPI_API_KEY: ${{ secrets.BRAPI_API_KEY }}
        run: |
          python -m app.jobs.atualizar_universo_acoes

  atualizar_fundamentos:
    name: Atualizar Fundamentos
    needs: atualizar_universo_acoes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        working-directory: backend-acoes-baratas
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Rodar job de fundamentos
        working-directory: backend-acoes-baratas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BRAPI_API_KEY: ${{ secrets.BRAPI_API_KEY }}
        run: |
          python -m app.jobs.atualizar_fundamentos

  atualizar_precos_diarios:
    name: Atualizar Preços Diários
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        working-directory: backend-acoes-baratas
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Rodar job de preços diários
        working-directory: backend-acoes-baratas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BRAPI_API_KEY: ${{ secrets.BRAPI_API_KEY }}
        run: |
          python -m app.jobs.atualizar_precos_diarios

  atualizar_cotacoes_snapshot:
    name: Atualizar Cotações (Tempo Real)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Instalar dependências
        working-directory: backend-acoes-baratas
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Rodar job de cotações snapshot
        working-directory: backend-acoes-baratas
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BRAPI_API_KEY: ${{ secrets.BRAPI_API_KEY }}
        run: |
          python -m app.jobs.atualizar_cotacoes_snapshot
